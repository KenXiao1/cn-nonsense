---
const repo = import.meta.env.PUBLIC_GISCUS_REPO ?? "KenXiao1/cn-nonsense";
const repoId = import.meta.env.PUBLIC_GISCUS_REPO_ID ?? "";
const category = import.meta.env.PUBLIC_GISCUS_CATEGORY ?? "General";
const categoryId = import.meta.env.PUBLIC_GISCUS_CATEGORY_ID ?? "";
const mapping = import.meta.env.PUBLIC_GISCUS_MAPPING ?? "pathname";
const strict = import.meta.env.PUBLIC_GISCUS_STRICT ?? "0";
const reactionsEnabled = import.meta.env.PUBLIC_GISCUS_REACTIONS_ENABLED ?? "1";
const emitMetadata = import.meta.env.PUBLIC_GISCUS_EMIT_METADATA ?? "0";
const inputPosition = import.meta.env.PUBLIC_GISCUS_INPUT_POSITION ?? "top";
const theme = import.meta.env.PUBLIC_GISCUS_THEME ?? "preferred_color_scheme";
const lang = import.meta.env.PUBLIC_GISCUS_LANG ?? "zh-CN";
---

<section class="frame comments" id="giscus-comments" data-giscus-theme={theme}>
  <h2>章节评论</h2>
  {
    repoId && categoryId ? (
      <>
        <script
          src="https://giscus.app/client.js"
          data-repo={repo}
          data-repo-id={repoId}
          data-category={category}
          data-category-id={categoryId}
          data-mapping={mapping}
          data-strict={strict}
          data-reactions-enabled={reactionsEnabled}
          data-emit-metadata={emitMetadata}
          data-input-position={inputPosition}
          data-theme={theme}
          data-lang={lang}
          crossorigin="anonymous"
          async
        ></script>
        <script>
          import { createGiscusThemeMessage, resolveGiscusTheme } from "../utils/giscus-theme.ts";

          (() => {
            const section = document.getElementById("giscus-comments");
            if (!(section instanceof HTMLElement)) {
              return;
            }

            const configuredTheme = section.dataset.giscusTheme ?? "preferred_color_scheme";

            const syncGiscusTheme = () => {
              const frame = section.querySelector("iframe.giscus-frame");
              if (!(frame instanceof HTMLIFrameElement) || !frame.contentWindow) {
                return;
              }

              const isDark = document.documentElement.classList.contains("dark");
              const nextTheme = resolveGiscusTheme(configuredTheme, isDark);
              frame.contentWindow.postMessage(
                createGiscusThemeMessage(nextTheme),
                "https://giscus.app"
              );
            };

            const htmlObserver = new MutationObserver((mutations) => {
              for (const mutation of mutations) {
                if (mutation.type === "attributes" && mutation.attributeName === "class") {
                  syncGiscusTheme();
                  break;
                }
              }
            });
            htmlObserver.observe(document.documentElement, {
              attributes: true,
              attributeFilter: ["class"]
            });

            const frameObserver = new MutationObserver(syncGiscusTheme);
            frameObserver.observe(section, { childList: true, subtree: true });

            syncGiscusTheme();
          })();
        </script>
      </>
    ) : (
      <p class="setup-tip">
        尚未配置 giscus ID。请在环境变量中设置
        <code>PUBLIC_GISCUS_REPO_ID</code> 和 <code>PUBLIC_GISCUS_CATEGORY_ID</code>。
      </p>
    )
  }
</section>

<style>
  .comments {
    margin-top: 2rem;
  }

  .comments h2 {
    margin-top: 0;
    margin-bottom: 0.8rem;
    font-size: 1.3rem;
  }

  .setup-tip {
    margin: 0;
    color: var(--muted);
    line-height: 1.8;
  }

  code {
    font-family: "Cascadia Mono", "Consolas", monospace;
    background: rgba(186, 27, 29, 0.08);
    padding: 0.1rem 0.28rem;
    border-radius: 0.25rem;
  }
</style>
