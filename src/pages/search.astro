---
import BaseLayout from "../layouts/BaseLayout.astro";
---

<BaseLayout title="全文检索" description="全文检索《全中国最激烈故事》已发布章节。">
  <section class="frame">
    <h2>全文检索</h2>
    <label for="query" class="search-label">搜索关键词</label>
    <input
      id="query"
      type="search"
      placeholder="输入关键词，例如：战神综合征"
      autocomplete="off"
      aria-label="搜索关键词"
    />
    <p class="tip">基于构建索引搜索标题与正文，最多显示前 30 条。</p>
    <p id="search-status" class="status" role="status" aria-live="polite"></p>
    <ul id="results" aria-live="polite"></ul>
  </section>
</BaseLayout>

<script>
  (function () {
    const input = document.querySelector("#query");
    const resultEl = document.querySelector("#results");
    const statusEl = document.querySelector("#search-status");

    if (
      !(input instanceof HTMLInputElement) ||
      !(resultEl instanceof HTMLUListElement) ||
      !(statusEl instanceof HTMLParagraphElement)
    ) {
      return;
    }

    let pagefind = null;
    let timer = null;
    let activeSearchToken = 0;

    function setStatus(message) {
      statusEl.textContent = message;
    }

    function clearResults() {
      resultEl.textContent = "";
    }

    function stripTags(text) {
      return text.replace(/<[^>]+>/g, "").replace(/\s+/g, " ").trim();
    }

    function appendResult(item) {
      const li = document.createElement("li");
      const link = document.createElement("a");
      const desc = document.createElement("p");

      link.href = item.url;
      link.textContent = item.title;
      desc.textContent = item.excerpt || "仅标题命中";

      li.appendChild(link);
      li.appendChild(desc);
      resultEl.appendChild(li);
    }

    async function ensurePagefind() {
      if (pagefind) {
        return pagefind;
      }

      try {
        const modulePath = "/pagefind/pagefind.js";
        pagefind = await import(/* @vite-ignore */ modulePath);
        return pagefind;
      } catch (_) {
        setStatus("搜索索引尚未就绪。请先执行 npm run build，再访问搜索页。");
        return null;
      }
    }

    async function runSearch(keyword, token) {
      const mod = await ensurePagefind();
      if (!mod) {
        clearResults();
        return;
      }

      if (!keyword) {
        clearResults();
        setStatus("");
        return;
      }

      setStatus("正在搜索...");
      try {
        const response = await mod.search(keyword);
        const topResults = response.results.slice(0, 30);

        clearResults();
        for (const hit of topResults) {
          if (token !== activeSearchToken) {
            return;
          }
          const data = await hit.data();
          appendResult({
            url: data.url,
            title: data.meta.title,
            excerpt: stripTags(data.excerpt || "")
          });
        }

        if (topResults.length === 0) {
          setStatus(`没有找到“${keyword}”相关结果。`);
        } else {
          setStatus(`找到 ${topResults.length} 条结果。`);
        }
      } catch (_) {
        clearResults();
        setStatus("搜索暂时不可用，请稍后刷新重试。");
      }
    }

    input.addEventListener("input", () => {
      const keyword = input.value.trim();
      activeSearchToken += 1;
      const currentToken = activeSearchToken;
      if (timer) {
        clearTimeout(timer);
      }
      timer = setTimeout(() => {
        void runSearch(keyword, currentToken);
      }, 120);
    });
  })();
</script>

<style is:global>
  h2 {
    margin: 0;
  }

  .search-label {
    display: inline-block;
    margin-top: 0.8rem;
    font-size: 0.92rem;
    color: var(--muted);
  }

  #query {
    width: 100%;
    margin-top: 0.45rem;
    border: 1px solid var(--line);
    border-radius: 0.35rem;
    font-size: 1rem;
    padding: 0.58rem 0.72rem;
    background: var(--paper);
    color: var(--bg-ink);
  }

  .tip {
    color: var(--muted);
    font-size: 0.9rem;
    margin-top: 0.6rem;
    margin-bottom: 0.2rem;
  }

  .status {
    margin: 0.4rem 0 0;
    color: var(--muted);
    font-size: 0.88rem;
    min-height: 1.3rem;
  }

  #results {
    margin: 0.2rem 0 0;
    padding: 0;
    list-style: none;
    display: grid;
    gap: 1px;
  }

  #results li {
    border-radius: 0.35rem;
    border: 1px solid transparent;
    transition: background 0.15s, border-color 0.15s;
  }

  #results li:hover {
    background: var(--bg);
    border-color: var(--line);
  }

  #results a {
    display: block;
    padding: 0.55rem 0.75rem 0;
    text-decoration: none;
    color: var(--bg-ink);
    font-weight: 600;
    transition: color 0.15s;
  }

  #results li:hover a {
    color: var(--accent);
  }

  #results p {
    margin: 0.25rem 0 0;
    padding: 0 0.75rem 0.55rem;
    color: var(--muted);
    font-size: 0.9rem;
  }
</style>
