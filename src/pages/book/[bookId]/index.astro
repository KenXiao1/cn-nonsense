---
import BaseLayout from "../../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const books = await getCollection("books");
  return books.map((book) => ({
    params: { bookId: book.data.book_id },
    props: { book }
  }));
}

const { book } = Astro.props;
const chapters = (await getCollection("chapters", ({ data }) =>
  data.book_id === book.data.book_id && data.status === "active"
)).sort((a, b) => a.data.order - b.data.order);
---

<BaseLayout
  title={`${book.data.title} · 目录`}
  description={`${book.data.title}章节目录与在线阅读入口。`}
>
  <section class="frame">
    <h2>{book.data.title}</h2>
    <ol>
      {chapters.map((chapter, i) => (
        <li>
          <a href={`/book/${book.data.book_id}/chapter/${chapter.data.chapter_id}`}>
            <span class="num">{String(i + 1).padStart(2, '0')}</span>
            <span class="title">{chapter.data.title}</span>
            <span class="arrow">→</span>
          </a>
        </li>
      ))}
    </ol>
  </section>

  <script is:inline>
    (function(){
      var hist = [];
      try {
        var raw = localStorage.getItem('readHistory');
        var parsed = JSON.parse(raw || '[]');
        hist = Array.isArray(parsed) ? parsed : [];
      } catch (_) {
        hist = [];
      }
      var read = {};
      hist.forEach(function(h){ read[h.id] = true; });
      document.querySelectorAll('ol li a').forEach(function(a){
        var m = a.getAttribute('href').match(/chapter\/([^/]+)$/);
        if(m && read[m[1]]) a.classList.add('read');
      });
    })();
  </script>
</BaseLayout>

<style>
  h2 { margin: 0 0 1rem; }
  ol {
    margin: 0;
    padding: 0;
    list-style: none;
    display: grid;
    gap: 1px;
  }
  li a {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.6rem 0.75rem;
    text-decoration: none;
    color: var(--bg-ink);
    border-radius: 0.35rem;
    border: 1px solid transparent;
    cursor: pointer;
    transition: background .15s, border-color .15s, padding-left .15s;
  }
  li a:hover {
    background: var(--bg);
    border-color: var(--line);
    padding-left: 1rem;
  }
  li a:hover .title { color: var(--accent); }
  li a:hover .arrow { opacity: 1; color: var(--accent); }
  .num {
    color: var(--muted);
    font-size: 0.82rem;
    min-width: 1.5rem;
  }
  .title { flex: 1; }
  .arrow {
    opacity: 0;
    color: var(--muted);
    font-size: 0.85rem;
    transition: opacity .15s, color .15s;
  }
  :global(li a.read) .num::before {
    content: "✓ ";
    color: var(--muted);
    font-size: 0.72rem;
  }
  :global(li a.read) .title { color: var(--muted); }
</style>
