---
import BaseLayout from "../../../../layouts/BaseLayout.astro";
import GiscusComments from "../../../../components/GiscusComments.astro";
import { getCollection, render } from "astro:content";
import { createExcerpt } from "../../../../utils/content-meta";

export async function getStaticPaths() {
  const chapters = await getCollection("chapters", ({ data }) => data.status === "active");
  return chapters.map((chapter) => ({
    params: {
      bookId: chapter.data.book_id,
      chapterId: chapter.data.chapter_id
    },
    props: {
      chapter
    }
  }));
}

const { chapter } = Astro.props;
const { Content } = await render(chapter);
const book = (await getCollection("books", ({ data }) => data.book_id === chapter.data.book_id))[0];
const chapterDescription = createExcerpt(chapter.body);
const siteUrl = Astro.site ?? new URL("https://cn-nonsense.netlify.app");
const chapterPath = `/book/${chapter.data.book_id}/chapter/${chapter.data.chapter_id}`;
const chapterUrl = new URL(chapterPath, siteUrl).toString();
const bookUrl = new URL(`/book/${chapter.data.book_id}`, siteUrl).toString();
const chapterStructuredData = {
  "@context": "https://schema.org",
  "@type": "Chapter",
  headline: chapter.data.title,
  name: chapter.data.title,
  description: chapterDescription,
  inLanguage: "zh-CN",
  dateModified: chapter.data.updated_at,
  url: chapterUrl,
  isPartOf: {
    "@type": "Book",
    name: book?.data.title ?? chapter.data.book_id,
    url: bookUrl
  }
};

const siblingChapters = (await getCollection("chapters", ({ data }) =>
  data.book_id === chapter.data.book_id && data.status === "active"
)).sort((a, b) => a.data.order - b.data.order);

const currentIndex = siblingChapters.findIndex(
  (item) => item.data.chapter_id === chapter.data.chapter_id
);
const prev = currentIndex > 0 ? siblingChapters[currentIndex - 1] : null;
const next = currentIndex >= 0 && currentIndex < siblingChapters.length - 1
  ? siblingChapters[currentIndex + 1]
  : null;
---

<BaseLayout
  title={`${chapter.data.title} · 在线阅读`}
  description={chapterDescription}
  ogType="article"
>
  <Fragment slot="head">
    <script type="application/ld+json" set:html={JSON.stringify(chapterStructuredData)}></script>
  </Fragment>
  <div class="reader-toolbar">
    <button id="font-dec" aria-label="缩小字体">A-</button>
    <span id="font-label">中</span>
    <button id="font-inc" aria-label="放大字体">A+</button>
  </div>
  <article class="frame chapter" id="chapter-body">
    <header>
      <h2>{chapter.data.title}</h2>
    </header>
    <Content />
  </article>

  <nav class="frame pager">
    {prev ? (
      <a href={`/book/${chapter.data.book_id}/chapter/${prev.data.chapter_id}`}>
        ← 上一章：{prev.data.title}
      </a>
    ) : <span>← 已是第一章</span>}
    {next ? (
      <a href={`/book/${chapter.data.book_id}/chapter/${next.data.chapter_id}`}>
        下一章：{next.data.title} →
      </a>
    ) : <span>已是最后一章 →</span>}
  </nav>

  <button id="back-top" aria-label="返回顶部" title="返回顶部">↑</button>

  <GiscusComments />

  <script is:inline define:vars={{ bookId: chapter.data.book_id, chapterId: chapter.data.chapter_id, chapterTitle: chapter.data.title }}>
    (function(){
      function safeGet(key, fallbackValue) {
        try {
          var value = localStorage.getItem(key);
          return value === null ? fallbackValue : value;
        } catch (_) {
          return fallbackValue;
        }
      }

      function safeSet(key, value) {
        try {
          localStorage.setItem(key, value);
        } catch (_) {
          // Ignore storage failures (private mode / quota / disabled storage)
        }
      }

      function readHistory() {
        try {
          var parsed = JSON.parse(safeGet('readHistory', '[]'));
          return Array.isArray(parsed) ? parsed : [];
        } catch (_) {
          return [];
        }
      }

      // — 字体大小 —
      var sizes = [0.9, 0.96, 1.02, 1.1, 1.2, 1.35];
      var labels = ['小','较小','中','较大','大','巨大'];
      var idx = Number.parseInt(safeGet('readerFontIdx', '2'), 10);
      if (!Number.isFinite(idx)) idx = 2;
      if (idx < 0) idx = 0;
      if (idx > sizes.length - 1) idx = sizes.length - 1;
      var body = document.getElementById('chapter-body');
      var label = document.getElementById('font-label');
      var dec = document.getElementById('font-dec');
      var inc = document.getElementById('font-inc');
      if (!(body instanceof HTMLElement) || !(label instanceof HTMLElement)) return;
      function apply(){ body.style.fontSize = sizes[idx]+'rem'; label.textContent = labels[idx]; }
      apply();
      if (dec instanceof HTMLElement) {
        dec.onclick = function(){ if(idx>0){idx--;safeSet('readerFontIdx', String(idx));apply();} };
      }
      if (inc instanceof HTMLElement) {
        inc.onclick = function(){ if(idx<sizes.length-1){idx++;safeSet('readerFontIdx', String(idx));apply();} };
      }

      // — 阅读历史 —
      var hist = readHistory();
      hist = hist.filter(function(h){ return h.id !== chapterId; });
      hist.unshift({ book: bookId, id: chapterId, title: chapterTitle, ts: Date.now() });
      if(hist.length > 50) hist = hist.slice(0, 50);
      safeSet('readHistory', JSON.stringify(hist));

      // — 键盘左右切换章节 —
      var links = document.querySelectorAll('.pager a');
      var prevHref, nextHref;
      links.forEach(function(a){ if(a.textContent.indexOf('←')!==-1) prevHref=a.href; else nextHref=a.href; });
      document.addEventListener('keydown', function(e){
        if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA'||e.target.isContentEditable) return;
        if(e.key==='ArrowLeft'&&prevHref) location.href=prevHref;
        if(e.key==='ArrowRight'&&nextHref) location.href=nextHref;
      });

      // — 返回顶部 —
      var btn = document.getElementById('back-top');
      if (!(btn instanceof HTMLElement)) return;
      window.addEventListener('scroll', function(){ btn.style.display = window.scrollY > 400 ? '' : 'none'; });
      btn.style.display = 'none';
      btn.onclick = function(){ window.scrollTo({ top: 0, behavior: 'smooth' }); };
    })();
  </script>
</BaseLayout>

<style>
  .reader-toolbar {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 0.4rem;
    margin-bottom: 0.6rem;
    font-size: 0.85rem;
  }
  .reader-toolbar button {
    background: var(--paper);
    border: 1px solid var(--line);
    border-radius: 0.25rem;
    padding: 0.2rem 0.5rem;
    cursor: pointer;
    color: var(--muted);
    font-size: 0.82rem;
    transition: border-color .2s;
  }
  .reader-toolbar button:hover { border-color: var(--accent); color: var(--accent); }
  #font-label { color: var(--muted); min-width: 1.5em; text-align: center; }
  .chapter {
    line-height: 1.95;
    font-size: 1.02rem;
  }
  .chapter header {
    border-bottom: 1px dashed var(--line);
    margin-bottom: 1rem;
    padding-bottom: 0.8rem;
  }
  h2 {
    margin: 0;
    font-size: clamp(1.35rem, 3.5vw, 2rem);
  }
  :global(.chapter img) {
    max-width: 100%;
    height: auto;
    border: 1px solid var(--line);
    border-radius: 0.25rem;
  }
  .pager {
    margin-top: 1rem;
    display: flex;
    justify-content: space-between;
    gap: 0.8rem;
    flex-wrap: wrap;
  }
  .pager a, .pager span {
    color: var(--muted);
    text-decoration: none;
    font-size: 0.93rem;
  }
  .pager a:hover { color: var(--accent); }
  #back-top {
    position: fixed;
    right: 1.2rem;
    bottom: 1.5rem;
    width: 2.4rem;
    height: 2.4rem;
    border-radius: 50%;
    border: 1px solid var(--line);
    background: var(--paper);
    color: var(--muted);
    font-size: 1.1rem;
    cursor: pointer;
    opacity: .75;
    transition: opacity .2s, border-color .2s;
  }
  #back-top:hover { opacity: 1; border-color: var(--accent); color: var(--accent); }
</style>
