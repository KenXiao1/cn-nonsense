# 全中国最激烈故事 — 网站改进计划

## 背景

这是一个基于 Astro 5 的静态在线阅读站，内容从 DOCX 导入为 Markdown，部署在 Cloudflare Pages / Netlify。现有功能包括：暗色模式、字体大小调节、阅读历史、全文搜索、键盘导航、Giscus 评论。经过全面审查，发现以下可改进的方面。

---

## 一、紧急修复（安全 & 健壮性）

### 1. 搜索页 XSS 漏洞
- **文件**: `src/pages/search.astro:46-49`
- **问题**: `li.innerHTML` 直接拼接 `item.href`、`item.title`、`snippet`，未做 HTML 转义。如果章节内容含 `<script>` 或 HTML 标签，会被当作 HTML 执行
- **修复**: 用 DOM API（createElement / textContent）替代 innerHTML 拼接，或在插入前对文本做 escapeHtml 处理

### 2. localStorage 缺少 try/catch
- **文件**: `BaseLayout.astro:20`、`index.astro:40`、`[chapterId].astro:70-83`、`[bookId]/index.astro`
- **问题**: Safari 隐私模式、存储已满等场景下 localStorage 会抛异常，导致页面脚本中断
- **修复**: 所有 localStorage 调用包裹 try/catch，失败时静默降级

---

## 二、高优先级（SEO & 基础配置）

### 3. 修正 site URL
- **文件**: `astro.config.mjs:4`
- **问题**: 当前是占位符 `https://stories.example.com`，影响所有 SEO 功能
- **修复**: 改为实际域名（如 `https://cn-nonsense.pages.dev`）

### 4. 添加 sitemap + robots.txt
- **修改**: 安装 `@astrojs/sitemap`，在 `astro.config.mjs` 中注册；新建 `public/robots.txt`
- **效果**: 搜索引擎可正确发现和索引所有页面

### 5. 添加 OG 标签 + canonical URL
- **文件**: `src/layouts/BaseLayout.astro` 的 `<head>` 部分
- **添加**: `og:title`、`og:description`、`og:type`、`og:url`、`og:locale`、`<link rel="canonical">`
- **效果**: 微信/QQ/微博分享时显示预览卡片，而非裸链接

### 6. 配置 Giscus 环境变量
- **操作**: 访问 https://giscus.app 获取 REPO_ID 和 CATEGORY_ID，填入 `.env` 和部署平台的环境变量
- **效果**: 评论功能正常工作（当前因缺少 ID 而显示配置提示）

---

## 三、中优先级（用户体验 & 可维护性）

### 7. 封面图片本地化
- **文件**: `src/pages/index.astro:20`
- **问题**: 封面从 `raw.githubusercontent.com` 加载，速度慢且不稳定
- **修复**: 将 `images/COVER.jpg`（已在仓库根目录）复制到 `public/images/COVER.jpg`，src 改为 `/images/COVER.jpg`，并加 `loading="lazy"` + `width`/`height`

### 8. 搜索页可扩展性
- **文件**: `src/pages/search.astro:12`
- **问题**: `chapter.body` 全文嵌入页面 JSON，14 章约 200-400KB，随内容增长会膨胀
- **建议**: 短期可截断每章正文至前 2000 字符；长期考虑集成 [Pagefind](https://pagefind.app/)（Astro 原生支持，按需加载索引）

### 9. 无障碍：skip-to-content
- **文件**: `src/layouts/BaseLayout.astro`
- **添加**: `<body>` 首个子元素加 `<a href="#main-content" class="skip-link">跳转到正文</a>`，`<main>` 加 `id="main-content"`
- **效果**: 键盘/屏幕阅读器用户可跳过导航直达正文

### 10. 添加 404 页面
- **新建**: `src/pages/404.astro`
- **效果**: 访问不存在的 URL 时保持站点风格，引导用户返回首页

### 11. 开启 Cloudflare Web Analytics
- **操作**: Cloudflare Pages 控制台开启即可，零代码改动
- **效果**: 了解访问量、热门章节、流量来源

---

## 四、低优先级（锦上添花）

### 12. RSS 订阅
- 安装 `@astrojs/rss`，新建 `src/pages/rss.xml.ts`，约 20 行代码
- 读者可通过 RSS 阅读器订阅新章节

### 13. 结构化数据 (JSON-LD)
- 在章节页添加 `<script type="application/ld+json">` 的 Book/Chapter schema
- 搜索结果可能显示富摘要

### 14. 图片优化
- 章节内图片目前为原始 JPEG/PNG，可考虑用 Astro 的 `<Image>` 组件自动优化
- 需调整内容导入流程，优先级较低

### 15. 搜索输入框加 aria-label
- `src/pages/search.astro:19` 的 `<input>` 缺少 `<label>` 或 `aria-label`
- 一行改动：加 `aria-label="搜索关键词"`

---

## 实施顺序

依赖关系：项目 3（修正 site URL）是项目 4、5、12 的前置条件。其余互相独立。

1. 修复 XSS（#1）
2. 修复 localStorage（#2）
3. 修正 site URL（#3）
4. sitemap + robots.txt（#4）+ OG 标签（#5）— 可一起做
5. 配置 Giscus（#6）
6. 封面图片本地化（#7）
7. 其余按需推进

## 验证方式

- XSS 修复：在搜索框输入 `<img src=x onerror=alert(1)>` 确认不触发
- localStorage：浏览器 DevTools 中模拟 localStorage 不可用，确认页面不报错
- SEO：构建后检查 `dist/sitemap-index.xml` 和 `dist/robots.txt` 是否生成
- OG 标签：用 https://www.opengraph.xyz/ 测试分享预览
- Giscus：部署后在章节页底部确认评论框正常加载
